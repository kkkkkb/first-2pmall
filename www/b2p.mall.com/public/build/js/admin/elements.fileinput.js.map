{"version":3,"sources":["elements.fileinput.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"elements.fileinput.js","sourcesContent":["/**\r\n <b>Ace file input element</b>. Custom, simple file input element to style browser's default file input.\r\n*/\r\n(function($ , undefined) {\r\n\tvar multiplible = 'multiple' in document.createElement('INPUT');\r\n\tvar hasFileList = 'FileList' in window;//file list enabled in modern browsers\r\n\tvar hasFileReader = 'FileReader' in window;\r\n\tvar hasFile = 'File' in window;\r\n\r\n\tvar Ace_File_Input = function(element , settings) {\r\n\t\tvar self = this;\r\n\t\t\r\n\t\tvar attrib_values = ace.helper.getAttrSettings(element, $.fn.ace_file_input.defaults);\r\n\t\tthis.settings = $.extend({}, $.fn.ace_file_input.defaults, settings, attrib_values);\r\n\r\n\t\tthis.$element = $(element);\r\n\t\tthis.element = element;\r\n\t\tthis.disabled = false;\r\n\t\tthis.can_reset = true;\r\n\t\t\r\n\r\n\t\tthis.$element\r\n\t\t.off('change.ace_inner_call')\r\n\t\t.on('change.ace_inner_call', function(e , ace_inner_call){\r\n\t\t\tif(self.disabled) return;\r\n\t\t\r\n\t\t\tif(ace_inner_call === true) return;//this change event is called from above drop event and extra checkings are taken care of there\r\n\t\t\treturn handle_on_change.call(self);\r\n\t\t\t//if(ret === false) e.preventDefault();\r\n\t\t});\r\n\r\n\t\tvar parent_label = this.$element.closest('label').css({'display':'block'})\r\n\t\tvar tagName = parent_label.length == 0 ? 'label' : 'span';//if not inside a \"LABEL\" tag, use \"LABEL\" tag, otherwise use \"SPAN\"\r\n\t\tthis.$element.wrap('<'+tagName+' class=\"ace-file-input\" />');\r\n\r\n\t\tthis.apply_settings();\r\n\t\tthis.reset_input_field();//for firefox as it keeps selected file after refresh\r\n\t}\r\n\tAce_File_Input.error = {\r\n\t\t'FILE_LOAD_FAILED' : 1,\r\n\t\t'IMAGE_LOAD_FAILED' : 2,\r\n\t\t'THUMBNAIL_FAILED' : 3\r\n\t};\r\n\r\n\r\n\tAce_File_Input.prototype.apply_settings = function() {\r\n\t\tvar self = this;\r\n\r\n\t\tthis.multi = this.$element.attr('multiple') && multiplible;\r\n\t\tthis.well_style = this.settings.style == 'well';\r\n\r\n\t\tif(this.well_style) {\r\n\t\t\tif( !this.settings.thumbnail ) this.settings.thumbnail = 'small';\r\n\t\t\tthis.$element.parent().addClass('ace-file-multiple');\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis.$element.parent().removeClass('ace-file-multiple');\r\n\t\t}\r\n\r\n\r\n\t\tthis.$element.parent().find(':not(input[type=file])').remove();//remove all except our input, good for when changing settings\r\n\t\tthis.$element.after('<span class=\"ace-file-container\" data-title=\"'+this.settings.btn_choose+'\"><span class=\"ace-file-name\" data-title=\"'+this.settings.no_file+'\">'+(this.settings.no_icon ? '<i class=\"'+ ace.vars['icon'] + this.settings.no_icon+'\"></i>' : '')+'</span></span>');\r\n\t\tthis.$label = this.$element.next();\r\n\t\tthis.$container = this.$element.closest('.ace-file-input');\r\n\r\n\t\tvar remove_btn = !!this.settings.icon_remove;\r\n\t\tif(remove_btn) {\r\n\t\t\tvar btn = \r\n\t\t\t$('<a class=\"remove\" href=\"#\"><i class=\"'+ ace.vars['icon'] + this.settings.icon_remove+'\"></i></a>')\r\n\t\t\t.appendTo(this.$element.parent());\r\n\r\n\t\t\tbtn.on(ace.click_event, function(e){\r\n\t\t\t\te.preventDefault();\r\n\t\t\t\tif( !self.can_reset ) return false;\r\n\t\t\t\t\r\n\t\t\t\tvar ret = true;\r\n\t\t\t\tif(self.settings.before_remove) ret = self.settings.before_remove.call(self.element);\r\n\t\t\t\tif(!ret) return false;\r\n\r\n\t\t\t\tvar r = self.reset_input();\r\n\t\t\t\treturn false;\r\n\t\t\t});\r\n\t\t}\r\n\r\n\r\n\t\tif(this.settings.droppable && hasFileList) {\r\n\t\t\tenable_drop_functionality.call(this);\r\n\t\t}\r\n\t}\r\n\r\n\tAce_File_Input.prototype.show_file_list = function($files , inner_call) {\r\n\t\tvar files = typeof $files === \"undefined\" ? this.$element.data('ace_input_files') : $files;\r\n\t\tif(!files || files.length == 0) return;\r\n\t\t\r\n\t\t//////////////////////////////////////////////////////////////////\r\n\t\t\r\n\t\tif(this.well_style) {\r\n\t\t\tthis.$label.find('.ace-file-name').remove();\r\n\t\t\tif(!this.settings.btn_change) this.$label.addClass('hide-placeholder');\r\n\t\t}\r\n\t\tthis.$label.attr('data-title', this.settings.btn_change).addClass('selected');\r\n\t\t\r\n\t\tfor (var i = 0; i < files.length; i++) {\r\n\t\t\tvar filename = '', format = false;\r\n\t\t\tif(typeof files[i] === \"string\") filename = files[i];\r\n\t\t\telse if(hasFile && files[i] instanceof File) filename = $.trim( files[i].name );\r\n\t\t\telse if(files[i] instanceof Object && files[i].hasOwnProperty('name')) {\r\n\t\t\t\t//format & name specified by user (pre-displaying name, etc)\r\n\t\t\t\tfilename = files[i].name;\r\n\t\t\t\tif(files[i].hasOwnProperty('type')) format = files[i].type;\r\n\t\t\t\tif(!files[i].hasOwnProperty('path')) files[i].path = files[i].name;\r\n\t\t\t}\r\n\t\t\telse continue;\r\n\t\t\t\r\n\t\t\tvar index = filename.lastIndexOf(\"\\\\\") + 1;\r\n\t\t\tif(index == 0)index = filename.lastIndexOf(\"/\") + 1;\r\n\t\t\tfilename = filename.substr(index);\r\n\t\t\t\r\n\t\t\tif(format == false) {\r\n\t\t\t\tif((/\\.(jpe?g|png|gif|svg|bmp|tiff?)$/i).test(filename)) {\t\t\t\t\r\n\t\t\t\t\tformat = 'image';\r\n\t\t\t\t}\r\n\t\t\t\telse if((/\\.(mpe?g|flv|mov|avi|swf|mp4|mkv|webm|wmv|3gp)$/i).test(filename)) {\r\n\t\t\t\t\tformat = 'video';\r\n\t\t\t\t}\r\n\t\t\t\telse if((/\\.(mp3|ogg|wav|wma|amr|aac)$/i).test(filename)) {\r\n\t\t\t\t\tformat = 'audio';\r\n\t\t\t\t}\r\n\t\t\t\telse format = 'file';\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tvar fileIcons = {\r\n\t\t\t\t'file' : 'fa fa-file',\r\n\t\t\t\t'image' : 'fa fa-picture-o file-image',\r\n\t\t\t\t'video' : 'fa fa-film file-video',\r\n\t\t\t\t'audio' : 'fa fa-music file-audio'\r\n\t\t\t};\r\n\t\t\tvar fileIcon = fileIcons[format];\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tif(!this.well_style) this.$label.find('.ace-file-name').attr({'data-title':filename}).find(ace.vars['.icon']).attr('class', ace.vars['icon'] + fileIcon);\r\n\t\t\telse {\r\n\t\t\t\tthis.$label.append('<span class=\"ace-file-name\" data-title=\"'+filename+'\"><i class=\"'+ ace.vars['icon'] + fileIcon+'\"></i></span>');\r\n\t\t\t\tvar type = (inner_call === true && hasFile && files[i] instanceof File) ? $.trim(files[i].type) : '';\r\n\t\t\t\tvar can_preview = hasFileReader && this.settings.thumbnail \r\n\t\t\t\t\t\t&&\r\n\t\t\t\t\t\t( (type.length > 0 && type.match('image')) || (type.length == 0 && format == 'image') )//the second one is for older Android's default browser which gives an empty text for file.type\r\n\t\t\t\tif(can_preview) {\r\n\t\t\t\t\tvar self = this;\r\n\t\t\t\t\t$.when(preview_image.call(this, files[i])).fail(function(result){\r\n\t\t\t\t\t\t//called on failure to load preview\r\n\t\t\t\t\t\tif(self.settings.preview_error) self.settings.preview_error.call(self, filename, result.code);\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\treturn true;\r\n\t}\r\n\t\r\n\tAce_File_Input.prototype.reset_input = function() {\r\n\t    this.reset_input_ui();\r\n\t\tthis.reset_input_field();\r\n\t}\r\n\t\r\n\tAce_File_Input.prototype.reset_input_ui = function() {\r\n\t\t this.$label.attr({'data-title':this.settings.btn_choose, 'class':'ace-file-container'})\r\n\t\t\t.find('.ace-file-name:first').attr({'data-title':this.settings.no_file , 'class':'ace-file-name'})\r\n\t\t\t.find(ace.vars['.icon']).attr('class', ace.vars['icon'] + this.settings.no_icon)\r\n\t\t\t.prev('img').remove();\r\n\t\t\tif(!this.settings.no_icon) this.$label.find(ace.vars['.icon']).remove();\r\n\t\t\r\n\t\tthis.$label.find('.ace-file-name').not(':first').remove();\r\n\t\t\r\n\t\tthis.reset_input_data();\r\n\t\t\r\n\t\t//if(ace.vars['old_ie']) ace.helper.redraw(this.$container[0]);\r\n\t}\r\n\tAce_File_Input.prototype.reset_input_field = function() {\r\n\t\t//http://stackoverflow.com/questions/1043957/clearing-input-type-file-using-jquery/13351234#13351234\r\n\t\tthis.$element.wrap('<form>').parent().get(0).reset();\r\n\t\tthis.$element.unwrap();\r\n\t\t\r\n\t\t//strangely when reset is called on this temporary inner form\r\n\t\t//only **IE9/10** trigger 'reset' on the outer form as well\r\n\t\t//and as we have mentioned to reset input on outer form reset\r\n\t\t//it causes infinite recusrsion by coming back to reset_input_field\r\n\t\t//thus calling reset again and again and again\r\n\t\t//so because when \"reset\" button of outer form is hit, file input is automatically reset\r\n\t\t//we just reset_input_ui to avoid recursion\r\n\t}\r\n\tAce_File_Input.prototype.reset_input_data = function() {\r\n\t\tif(this.$element.data('ace_input_files')) {\r\n\t\t\tthis.$element.removeData('ace_input_files');\r\n\t\t\tthis.$element.removeData('ace_input_method');\r\n\t\t}\r\n\t}\r\n\r\n\tAce_File_Input.prototype.enable_reset = function(can_reset) {\r\n\t\tthis.can_reset = can_reset;\r\n\t}\r\n\r\n\tAce_File_Input.prototype.disable = function() {\r\n\t\tthis.disabled = true;\r\n\t\tthis.$element.attr('disabled', 'disabled').addClass('disabled');\r\n\t}\r\n\tAce_File_Input.prototype.enable = function() {\r\n\t\tthis.disabled = false;\r\n\t\tthis.$element.removeAttr('disabled').removeClass('disabled');\r\n\t}\r\n\r\n\tAce_File_Input.prototype.files = function() {\r\n\t\treturn $(this).data('ace_input_files') || null;\r\n\t}\r\n\tAce_File_Input.prototype.method = function() {\r\n\t\treturn $(this).data('ace_input_method') || '';\r\n\t}\r\n\t\r\n\tAce_File_Input.prototype.update_settings = function(new_settings) {\r\n\t\tthis.settings = $.extend({}, this.settings, new_settings);\r\n\t\tthis.apply_settings();\r\n\t}\r\n\t\r\n\tAce_File_Input.prototype.loading = function(is_loading) {\r\n\t\tif(is_loading === false) {\r\n\t\t\tthis.$container.find('.ace-file-overlay').remove();\r\n\t\t\tthis.element.removeAttribute('readonly');\r\n\t\t}\r\n\t\telse {\r\n\t\t\tvar inside = typeof is_loading === 'string' ? is_loading : '<i class=\"overlay-content fa fa-spin fa-spinner orange2 fa-2x\"></i>';\r\n\t\t\tvar loader = this.$container.find('.ace-file-overlay');\r\n\t\t\tif(loader.length == 0) {\r\n\t\t\t\tloader = $('<div class=\"ace-file-overlay\"></div>').appendTo(this.$container);\r\n\t\t\t\tloader.on('click tap', function(e) {\r\n\t\t\t\t\te.stopImmediatePropagation();\r\n\t\t\t\t\te.preventDefault();\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t});\r\n\t\t\t\t\r\n\t\t\t\tthis.element.setAttribute('readonly' , 'true');//for IE\r\n\t\t\t}\r\n\t\t\tloader.empty().append(inside);\r\n\t\t}\r\n\t}\r\n\r\n\r\n\r\n\tvar enable_drop_functionality = function() {\r\n\t\tvar self = this;\r\n\t\t\r\n\t\tvar dropbox = this.$element.parent();\r\n\t\tdropbox\r\n\t\t.off('dragenter')\r\n\t\t.on('dragenter', function(e){\r\n\t\t\te.preventDefault();\r\n\t\t\te.stopPropagation();\r\n\t\t})\r\n\t\t.off('dragover')\r\n\t\t.on('dragover', function(e){\r\n\t\t\te.preventDefault();\r\n\t\t\te.stopPropagation();\r\n\t\t})\r\n\t\t.off('drop')\r\n\t\t.on('drop', function(e){\r\n\t\t\te.preventDefault();\r\n\t\t\te.stopPropagation();\r\n\r\n\t\t\tif(self.disabled) return;\r\n\t\t\r\n\t\t\tvar dt = e.originalEvent.dataTransfer;\r\n\t\t\tvar file_list = dt.files;\r\n\t\t\tif(!self.multi && file_list.length > 1) {//single file upload, but dragged multiple files\r\n\t\t\t\tvar tmpfiles = [];\r\n\t\t\t\ttmpfiles.push(file_list[0]);\r\n\t\t\t\tfile_list = tmpfiles;//keep only first file\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tfile_list = processFiles.call(self, file_list, true);//true means files have been selected, not dropped\r\n\t\t\tif(file_list === false) return false;\r\n\r\n\t\t\tself.$element.data('ace_input_method', 'drop');\r\n\t\t\tself.$element.data('ace_input_files', file_list);//save files data to be used later by user\r\n\r\n\t\t\tself.show_file_list(file_list , true);\r\n\t\t\t\r\n\t\t\tself.$element.triggerHandler('change' , [true]);//true means ace_inner_call\r\n\t\t\treturn true;\r\n\t\t});\r\n\t}\r\n\t\r\n\t\r\n\tvar handle_on_change = function() {\r\n\t\tvar file_list = this.element.files || [this.element.value];/** make it an array */\r\n\t\t\r\n\t\tfile_list = processFiles.call(this, file_list, false);//false means files have been selected, not dropped\r\n\t\tif(file_list === false) return false;\r\n\t\t\r\n\t\tthis.$element.data('ace_input_method', 'select');\r\n\t\tthis.$element.data('ace_input_files', file_list);\r\n\t\t\r\n\t\tthis.show_file_list(file_list , true);\r\n\t\t\r\n\t\treturn true;\r\n\t}\r\n\r\n\r\n\r\n\tvar preview_image = function(file) {\r\n\t\tvar self = this;\r\n\t\tvar $span = self.$label.find('.ace-file-name:last');//it should be out of onload, otherwise all onloads may target the same span because of delays\r\n\t\t\r\n\t\tvar deferred = new $.Deferred;\r\n\t\t\r\n\t\tvar getImage = function(src, $file) {\r\n\t\t\t$span.prepend(\"<img class='middle' style='display:none;' />\");\r\n\t\t\tvar img = $span.find('img:last').get(0);\r\n\t\t\r\n\t\t\t$(img).one('load', function() {\r\n\t\t\t\timgLoaded.call(null, img, $file);\r\n\t\t\t}).one('error', function() {\r\n\t\t\t\timgFailed.call(null, img);\r\n\t\t\t});\r\n\r\n\t\t\timg.src = src;\r\n\t\t}\r\n\t\tvar imgLoaded = function(img, $file) {\r\n\t\t\t//if image loaded successfully\r\n\t\t\t\r\n\t\t\tvar size = self.settings['previewSize'];\r\n\t\t\t\r\n\t\t\tif(!size) {\r\n\t\t\t\tif(self.settings['previewWidth'] || self.settings['previewHeight']) {\r\n\t\t\t\t\tsize = {previewWidth: self.settings['previewWidth'], previewHeight: self.settings['previewHeight']}\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tsize = 50;\r\n\t\t\t\t\tif(self.settings.thumbnail == 'large') size = 150;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif(self.settings.thumbnail == 'fit') size = $span.width();\r\n\t\t\telse if(typeof size == 'number') size = parseInt(Math.min(size, $span.width()));\r\n\r\n\r\n\t\t\tvar thumb = get_thumbnail(img, size/**, file.type*/);\r\n\t\t\tif(thumb == null) {\r\n\t\t\t\t//if making thumbnail fails\r\n\t\t\t\t$(this).remove();\r\n\t\t\t\tdeferred.reject({code:Ace_File_Input.error['THUMBNAIL_FAILED']});\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tvar showPreview = true;\r\n\t\t\t//add width/height info to \"file\" and trigger preview finished event for each image!\r\n\t\t\tif($file && $file instanceof File) {\r\n\t\t\t\t$file.width = thumb.width;\r\n\t\t\t\t$file.height = thumb.height;\r\n\t\t\t\tself.$element.trigger('file.preview.ace', {'file': $file});\r\n\t\t\t\t\r\n\t\t\t\tvar event\r\n\t\t\t\tself.$element.trigger( event = new $.Event('file.preview.ace'), {'file': $file} );\r\n\t\t\t\tif ( event.isDefaultPrevented() ) showPreview = false;\r\n\t\t\t}\r\n\r\n\r\n\t\t\tif(showPreview) {\r\n\t\t\t\tvar w = thumb.previewWidth, h = thumb.previewHeight;\r\n\t\t\t\tif(self.settings.thumbnail == 'small') {w=h=parseInt(Math.max(w,h))}\r\n\t\t\t\telse $span.addClass('large');\r\n\r\n\t\t\t\t$(img).css({'background-image':'url('+thumb.src+')' , width:w, height:h})\r\n\t\t\t\t\t\t.data('thumb', thumb.src)\r\n\t\t\t\t\t\t.attr({src:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=='})\r\n\t\t\t\t\t\t.show()\r\n\t\t\t}\r\n\r\n\t\t\t///////////////////\r\n\t\t\tdeferred.resolve();\r\n\t\t}\r\n\t\tvar imgFailed = function(img) {\r\n\t\t\t//for example when a file has image extenstion, but format is something else\r\n\t\t\t$span.find('img').remove();\r\n\t\t\tdeferred.reject({code:Ace_File_Input.error['IMAGE_LOAD_FAILED']});\r\n\t\t}\r\n\t\t\r\n\t\tif(hasFile && file instanceof File) {\r\n\t\t\tvar reader = new FileReader();\r\n\t\t\treader.onload = function (e) {\r\n\t\t\t\tgetImage(e.target.result, file);\r\n\t\t\t}\r\n\t\t\treader.onerror = function (e) {\r\n\t\t\t\tdeferred.reject({code:Ace_File_Input.error['FILE_LOAD_FAILED']});\r\n\t\t\t}\r\n\t\t\treader.readAsDataURL(file);\r\n\t\t}\r\n\t\telse {\r\n\t\t\tif(file instanceof Object && file.hasOwnProperty('path')) {\r\n\t\t\t\tgetImage(file.path, null);//file is a file name (path) --- this is used to pre-show user-selected image\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\treturn deferred.promise();\r\n\t}\r\n\r\n\tvar get_thumbnail = function(img, size, type) {\r\n\t\tvar imgWidth = img.width, imgHeight = img.height;\r\n\t\t\r\n\t\t//**IE10** is not giving correct width using img.width so we use $(img).width()\r\n\t\timgWidth = imgWidth > 0 ? imgWidth : $(img).width()\r\n\t\timgHeight = imgHeight > 0 ? imgHeight : $(img).height()\r\n\r\n\t\tvar previewSize = false, previewHeight = false, previewWidth = false;\r\n\t\tif(typeof size == 'number') previewSize = size;\r\n\t\telse if(size instanceof Object) {\r\n\t\t\tif(size['previewWidth'] && !size['previewHeight']) previewWidth = size['previewWidth'];\r\n\t\t\telse if(size['previewHeight'] && !size['previewWidth']) previewHeight = size['previewHeight'];\r\n\t\t\telse if(size['previewWidth'] && size['previewHeight']) {\r\n\t\t\t\tpreviewWidth = size['previewWidth'];\r\n\t\t\t\tpreviewHeight = size['previewHeight'];\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif(previewSize) {\r\n\t\t\tif(imgWidth > imgHeight) {\r\n\t\t\t\tpreviewWidth = previewSize;\r\n\t\t\t\tpreviewHeight = parseInt(imgHeight/imgWidth * previewWidth);\r\n\t\t\t} else {\r\n\t\t\t\tpreviewHeight = previewSize;\r\n\t\t\t\tpreviewWidth = parseInt(imgWidth/imgHeight * previewHeight);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse {\r\n\t\t\tif(!previewHeight && previewWidth) {\r\n\t\t\t\tpreviewHeight = parseInt(imgHeight/imgWidth * previewWidth);\r\n\t\t\t}\r\n\t\t\telse if(previewHeight && !previewWidth) {\r\n\t\t\t\tpreviewWidth = parseInt(imgWidth/imgHeight * previewHeight);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t\r\n\t\tvar dataURL\r\n\t\ttry {\r\n\t\t\tvar canvas = document.createElement('canvas');\r\n\t\t\tcanvas.width = previewWidth; canvas.height = previewHeight;\r\n\t\t\tvar context = canvas.getContext('2d');\r\n\t\t\tcontext.drawImage(img, 0, 0, imgWidth, imgHeight, 0, 0, previewWidth, previewHeight);\r\n\t\t\tdataURL = canvas.toDataURL(/*type == 'image/jpeg' ? type : 'image/png', 10*/)\r\n\t\t} catch(e) {\r\n\t\t\tdataURL = null;\r\n\t\t}\r\n\t\tif(! dataURL) return null;\r\n\t\t\r\n\r\n\t\t//there was only one image that failed in firefox completely randomly! so let's double check things\r\n\t\tif( !( /^data\\:image\\/(png|jpe?g|gif);base64,[0-9A-Za-z\\+\\/\\=]+$/.test(dataURL)) ) dataURL = null;\r\n\t\tif(! dataURL) return null;\r\n\t\t\r\n\r\n\t\treturn {src: dataURL, previewWidth: previewWidth, previewHeight: previewHeight, width: imgWidth, height: imgHeight};\r\n\t}\r\n\t\r\n\r\n\t\r\n\tvar processFiles = function(file_list, dropped) {\r\n\t\tvar ret = checkFileList.call(this, file_list, dropped);\r\n\t\tif(ret === -1) {\r\n\t\t\tthis.reset_input();\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tif( !ret || ret.length == 0 ) {\r\n\t\t\tif( !this.$element.data('ace_input_files') ) this.reset_input();\r\n\t\t\t//if nothing selected before, reset because of the newly unacceptable (ret=false||length=0) selection\r\n\t\t\t//otherwise leave the previous selection intact?!!!\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tif (ret instanceof Array || (hasFileList && ret instanceof FileList)) file_list = ret;\r\n\t\t\r\n\t\t\r\n\t\tret = true;\r\n\t\tif(this.settings.before_change) ret = this.settings.before_change.call(this.element, file_list, dropped);\r\n\t\tif(ret === -1) {\r\n\t\t\tthis.reset_input();\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tif(!ret || ret.length == 0) {\r\n\t\t\tif( !this.$element.data('ace_input_files') ) this.reset_input();\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\t\r\n\t\t//inside before_change you can return a modified File Array as result\r\n\t\tif (ret instanceof Array || (hasFileList && ret instanceof FileList)) file_list = ret;\r\n\t\t\r\n\t\treturn file_list;\r\n\t}\r\n\t\r\n\t\r\n\tvar getExtRegex = function(ext) {\r\n\t\tif(!ext) return null;\r\n\t\tif(typeof ext === 'string') ext = [ext];\r\n\t\tif(ext.length == 0) return null;\r\n\t\treturn new RegExp(\"\\.(?:\"+ext.join('|')+\")$\", \"i\");\r\n\t}\r\n\tvar getMimeRegex = function(mime) {\r\n\t\tif(!mime) return null;\r\n\t\tif(typeof mime === 'string') mime = [mime];\r\n\t\tif(mime.length == 0) return null;\r\n\t\treturn new RegExp(\"^(?:\"+mime.join('|').replace(/\\//g, \"\\\\/\")+\")$\", \"i\");\r\n\t}\r\n\tvar checkFileList = function(files, dropped) {\r\n\t\tvar allowExt   = getExtRegex(this.settings.allowExt);\r\n\r\n\t\tvar denyExt    = getExtRegex(this.settings.denyExt);\r\n\t\t\r\n\t\tvar allowMime  = getMimeRegex(this.settings.allowMime);\r\n\r\n\t\tvar denyMime   = getMimeRegex(this.settings.denyMime);\r\n\r\n\t\tvar maxSize    = this.settings.maxSize || false;\r\n\t\t\r\n\t\tif( !(allowExt || denyExt || allowMime || denyMime || maxSize) ) return true;//no checking required\r\n\r\n\r\n\t\tvar safe_files = [];\r\n\t\tvar error_list = {}\r\n\t\tfor(var f = 0; f < files.length; f++) {\r\n\t\t\tvar file = files[f];\r\n\t\t\t\r\n\t\t\t//file is either a string(file name) or a File object\r\n\t\t\tvar filename = !hasFile ? file : file.name;\r\n\t\t\tif( allowExt && !allowExt.test(filename) ) {\r\n\t\t\t\t//extension not matching whitelist, so drop it\r\n\t\t\t\tif(!('ext' in error_list)) error_list['ext'] = [];\r\n\t\t\t\t error_list['ext'].push(filename);\r\n\t\t\t\t\r\n\t\t\t\tcontinue;\r\n\t\t\t} else if( denyExt && denyExt.test(filename) ) {\r\n\t\t\t\t//extension is matching blacklist, so drop it\r\n\t\t\t\tif(!('ext' in error_list)) error_list['ext'] = [];\r\n\t\t\t\t error_list['ext'].push(filename);\r\n\t\t\t\t\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tvar type;\r\n\t\t\tif( !hasFile ) {\r\n\t\t\t\t//in browsers that don't support FileReader API\r\n\t\t\t\tsafe_files.push(file);\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\telse if((type = $.trim(file.type)).length > 0) {\r\n\t\t\t\t//there is a mimetype for file so let's check against are rules\r\n\t\t\t\tif( allowMime && !allowMime.test(type) ) {\r\n\t\t\t\t\t//mimeType is not matching whitelist, so drop it\r\n\t\t\t\t\tif(!('mime' in error_list)) error_list['mime'] = [];\r\n\t\t\t\t\t error_list['mime'].push(filename);\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\t\t\t\telse if( denyMime && denyMime.test(type) ) {\r\n\t\t\t\t\t//mimeType is matching blacklist, so drop it\r\n\t\t\t\t\tif(!('mime' in error_list)) error_list['mime'] = [];\r\n\t\t\t\t\t error_list['mime'].push(filename);\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif( maxSize && file.size > maxSize ) {\r\n\t\t\t\t//file size is not acceptable\r\n\t\t\t\tif(!('size' in error_list)) error_list['size'] = [];\r\n\t\t\t\t error_list['size'].push(filename);\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tsafe_files.push(file)\r\n\t\t}\r\n\t\t\r\n\t\r\n\t\t\r\n\t\tif(safe_files.length == files.length) return files;//return original file list if all are valid\r\n\r\n\t\t/////////\r\n\t\tvar error_count = {'ext': 0, 'mime': 0, 'size': 0}\r\n\t\tif( 'ext' in error_list ) error_count['ext'] = error_list['ext'].length;\r\n\t\tif( 'mime' in error_list ) error_count['mime'] = error_list['mime'].length;\r\n\t\tif( 'size' in error_list ) error_count['size'] = error_list['size'].length;\r\n\t\t\r\n\t\tvar event\r\n\t\tthis.$element.trigger(\r\n\t\t\tevent = new $.Event('file.error.ace'), \r\n\t\t\t{\r\n\t\t\t\t'file_count': files.length,\r\n\t\t\t\t'invalid_count' : files.length - safe_files.length,\r\n\t\t\t\t'error_list' : error_list,\r\n\t\t\t\t'error_count' : error_count,\r\n\t\t\t\t'dropped': dropped\r\n\t\t\t}\r\n\t\t);\r\n\t\tif ( event.isDefaultPrevented() ) return -1;//it will reset input\r\n\t\t//////////\r\n\r\n\t\treturn safe_files;//return safe_files\r\n\t}\r\n\r\n\r\n\r\n\t///////////////////////////////////////////\r\n\t$.fn.aceFileInput = $.fn.ace_file_input = function (option,value) {\r\n\t\tvar retval;\r\n\r\n\t\tvar $set = this.each(function () {\r\n\t\t\tvar $this = $(this);\r\n\t\t\tvar data = $this.data('ace_file_input');\r\n\t\t\tvar options = typeof option === 'object' && option;\r\n\r\n\t\t\tif (!data) $this.data('ace_file_input', (data = new Ace_File_Input(this, options)));\r\n\t\t\tif (typeof option === 'string') retval = data[option](value);\r\n\t\t});\r\n\r\n\t\treturn (retval === undefined) ? $set : retval;\r\n\t};\r\n\r\n\r\n\t$.fn.ace_file_input.defaults = {\r\n\t\tstyle: false,\r\n\t\tno_file: 'No File ...',\r\n\t\tno_icon: 'fa fa-upload',\r\n\t\tbtn_choose: 'Choose',\r\n\t\tbtn_change: 'Change',\r\n\t\ticon_remove: 'fa fa-times',\r\n\t\tdroppable: false,\r\n\t\tthumbnail: false,//large, fit, small\r\n\t\t\r\n\t\tallowExt: null,\r\n\t\tdenyExt: null,\r\n\t\tallowMime: null,\r\n\t\tdenyMime: null,\r\n\t\tmaxSize: false,\r\n\t\t\r\n\t\tpreviewSize: false,\r\n\t\tpreviewWidth: false,\r\n\t\tpreviewHeight: false,\r\n\t\t\r\n\t\t//callbacks\r\n\t\tbefore_change: null,\r\n\t\tbefore_remove: null,\r\n\t\tpreview_error: null\r\n     }\r\n\r\n\r\n})(window.jQuery);\r\n"],"sourceRoot":"/source/"}